#!/bin/bash

# The Red Hat Security Response Team provides OVAL definitions
# for all vulnerabilities (identified by CVE name) that affect RHEL or Fedora.
# This enables users to perform a vulnerability scan and
# diagnose whether system is vulnerable.

# Run the scan in a protected directory since the scan
# can reveal security weaknesses on the host.
cd /root

# Download latest definitions.
#
curl -L -O http://www.redhat.com/security/data/metrics/com.redhat.rhsa-all.xccdf.xml
curl -L -O http://www.redhat.com/security/data/oval/com.redhat.rhsa-all.xml

# Run a vulnerability scan.
#
# Store machine-parseable report (XML).
# Store human-readable report (HTML).
#
# Exit status:
# 0 == finished successfully
# 1 == evaluation did not finish
# 2 == finished but system is incompliant
#
checkfile="com.redhat.rhsa-all.xccdf.xml"
outname="vulnerability-report"
oscap xccdf eval --results $outname.xml --report $outname.html $checkfile
RC=$?

# Reduce the size of the image.
rm -f com.redhat.rhsa-all.xccdf.xml com.redhat.rhsa-all.xml

# Print the exit status so it shows up in wercker console.
echo vulnerability scan exit status $RC

# If we exit non-zero, the docker build is a failure.
[[ $RC -eq 1 ]] && echo 'ERROR: evaluation did not finish'
[[ $RC -eq 2 ]] && echo 'ERROR: found 1 or more vulnerabilities (system is incompliant)'
exit $RC
